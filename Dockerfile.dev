## today-money-web (dev)
## - Runs Next.js dev server on port 3000
## - Uses Node.js 24
## - Assumes Postgres runs in a separate container on the same docker network
FROM node:24-bookworm-slim AS build
WORKDIR /usr/src/app

WORKDIR /usr/src/app

# Needed for Prisma engine detection/runtime
RUN apt-get update -y && apt-get install -y openssl ca-certificates && rm -rf /var/lib/apt/lists/*

COPY package*.json ./
RUN npm ci

COPY . ./

# generate prisma in-linux
RUN npx prisma generate

# build next
RUN npm run build

# runtime stage
FROM node:24-bookworm-slim AS runner
WORKDIR /usr/src/app

RUN apt-get update -y && apt-get install -y openssl ca-certificates && rm -rf /var/lib/apt/lists/*


ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

COPY --from=build /usr/src/app ./

EXPOSE 3000

CMD ["npm", "start"]
